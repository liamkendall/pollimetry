---
title: 'Pollimetry: Predictive allometry for pollinating insects'
author: "Liam Kendall, Vesna Gagic..........Romina Rader and Ignasi Bartomeus"
date: "24/04/2018"
---

```{r setup, include=FALSE}  
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(broom)
library(lme4)
library(phytools)
library(nlme)
library(phangorn)
library(ggtree)
library(MuMIn)
library(geiger)
#dataframe
poll_all <- read.csv(file="data/PA010518.csv")

#split to bees and hoverflies
poll_all$Spec.wgt=poll_all$Spec.wgt*1000
poll_all_split=split(poll_all,poll_all$Superfamily)
bee_all=poll_all_split[[1]]
hov_all=poll_all_split[[2]]

#JUST AUSTRALIA
bee_country=split(bee_all,bee_all$Country)
bee_australia=bee_country$Australia

#Preservative time data frame

#JUST AUST and GER
bee_country=split(bee_all,bee_all$Country)
bee_pres=rbind(bee_country$Australia,bee_country$Germany)

#Filter so only species with more than 1 preservative time

bee_pres=as.data.frame(bee_pres %>%
  group_by(Species) %>% 
  filter(n_distinct(Pres.time)>1))

##BEE mean dataframe
bee_mean=aggregate(Latitude~Family+Subfamily+Tribe+Region+Country+Measurement+Subfamily+Genus+Species+Sex,bee_all,mean)
bee_mean$Spec.wgt=as.numeric(unlist(aggregate(Spec.wgt~Family+Country+Subfamily+Tribe+Region+Measurement+
                                                Subfamily+Genus+Species+Sex,bee_all,mean)[10]))
bee_mean$IT=(as.numeric(unlist(aggregate(IT~Family+Subfamily+Tribe+Region+Country+
                                         Measurement+Subfamily+Genus+Species+Sex,bee_all,mean)[10])))


##Top five - for intraspecific variance
bee_species=split(bee_all,bee_all$Species)
hov_species=split(hov_all,hov_all$Species)

##PHYLO

bee_phylo=aggregate(Latitude~Family+Subfamily+
                      Tribe+Genus+Species,bee_all,median)
bee_phylo$Longitude=as.numeric(unlist(aggregate(Longitude~Family+Subfamily+
                                      Tribe+Genus+Species,bee_all,median)[6]))
bee_phylo$Spec.wgt=as.numeric(unlist(aggregate(Spec.wgt~Family+Subfamily+
                                      Tribe+Genus+Species,bee_all,mean)[6]))
bee_phylo$Wgt.SD=as.numeric(unlist(aggregate(log(Spec.wgt)~Family+Subfamily+
                                      Tribe+Genus+Species,bee_all,sd)[6]))
bee_phylo$IT=as.numeric(unlist(aggregate(IT~Family+Subfamily+
                                      Tribe+Genus+Species,bee_all,mean)[6]))
bee_phylo$IT.SD=as.numeric(unlist(aggregate(log(IT)~Family+Subfamily+
                                      Tribe+Genus+Species,bee_all,sd)[6]))
rownames(bee_phylo)=bee_phylo$Species

bee_phylo=bee_phylo[-93,]

##Build tree
##TREE
bee.phy=read.tree(file="raw_data/Bee_phylogeny_Hedtke_etal2013/12862_2013_2375_MOESM3_ESM.txt",keep.multi = TRUE)
##Use tree 1 (376 genera) #Genera-level phylogney
bee.phy=bee.phy[[1]]
bee.phy=as.phylo(bee.phy)
#bee.phy=force.ultrametric(bee.phy) Not sure if this is required
bee_pruned=drop.tip(bee.phy, setdiff(bee.phy$tip.label,bee_phylo$Genus))
bee_pruned=genus.to.species.tree(bee_pruned, species=bee_phylo$Species)


```

##Nacho

If you could help me with setting up the data files within this R markdown file, I will write the manuscript in it!

##Abstract

Allometric scaling laws have key implications for the conservation and management of pollinating insects in both managed and unmanaged ecosystems. 
Body size (BS) can predict influential ecological traits yet available predictive models are outdated, rely upon geographically restricted sampling and have limited applicability for non-bee taxa. 
More accurate prediction of pollinator body size require models that consider biogeography, intraspecific variation and phylogenetic relatedness. 

Here we present the results of an international collaboration that catalogued existing predictive allometries for pollinating insects (Hymenoptera (BS: 38, FD: 6), Diptera (BS: 26, FD: 0) and Lepidoptera (BS: 21, FD: 1) and improved upon pre-existing equations for estimating body size in key pollinating taxa (bees and hoverflies). 
We measured dry weight and intertegular span ~~and body length of bees and hoverflies from Australia (n = 900), Europe (n = 1000) and USA (n = 650) and constructed region-specific predictive equations for estimating pollinator body size within an iterative framework. These models, form the R package  'pollimetry', will be a useful resource in the conservation management and research of both wild and managed pollinators globally.


State of the art, Knowledge gaps! , How we fix them, Quick methods and main results. Conclusions about the iterative workflow.

##Introduction

Body size is an intrinsic trait of all organisms that influences key patterns across all levels of biological organisation. Adult body size variation (both intra- and interspecific) in insects is the outcome of natural selection affecting physiological and biochemical processes during ontogeny (see Chown & Gaston 2010’s review on body size variation). Therefore, body size is central to physiological (e.g. metabolic and growth rates (Angilletta et al. 2004; Ehnes et al. 2011; Harrison et al. 2014)), life history (e.g. life span, reproductive rate and type (i.e. capital or income breeders) (Speakman 2005; Teder et al. 2008)) and ecological attributes (e.g. species abundance and richness, trophic interactions, geographic range size, dispersal ability) (Brown et al. 2004; White et al. 2007; Chown & Gaston 2010, Rall et al. 2011; Stevens et al. 2012; Dell et al. 2011, 2014; Velghe & Gregory-Eaves 2013). These effects lead to differing spatial and temporal size-frequency distributions within populations and communities as well as drive key ecosystem functions and services such as decomposition, carbon cycling, primary productivity and pollination (Greenleaf et al. 2007; Rudolf & Rasmussen 2013; Schramski et al. 2015).

#Allometry 

Studies of body size variation utilise allometric theory. Gould (1966) defined allometry as the ‘study of size and its consequences.’ Allometric scaling laws refer to how traits, which can be morphological, physiological or chemical, co-vary with an organism’s body size, often with important ecological and evolutionary implications size (Gould 1966; Huxley 1993). However, direct measurements of body size and ecologically important traits can be impractical for a number of reasons. First, direct measurements can be time consuming and require destructive methods, which are unfeasible for museum specimens and threatened species (Rogers et al. 1976; Henschel & Seely 1997). Second, where research occurs in remote field sites, equipment limits can prevent direct measurements (Brady & Noske 2006). 
Thirdly, in diet/food web studies, body size estimates come from digested prey items (e.g. Hodar 1997).
Lastly, a lack of life-history information, especially for ecologically cryptic and rare species, may not be known.
 As such, predictive allometry, which attempts to estimate body size using a co-varying trait, has emerged across many biological disciplines.

#Pollination allometry

A number of key pollination traits exhibit allometry. In particular, body size affects insect activity rates/periods (i.e. floral visitation) (Strienzer et al. 2015), pollen load (Ramalho et al. 1998), foraging range (Greenleaf et al. 2007; van Nieuwstadt & Iraheta 1996) and proboscis length (Cariveau et al. 2016). Despite these influences, few predictive allometric models exist for pollinating insects, with one notable exception. Cane (1987) established a predictive allometric model for bee body size as a function of the intertegular span (the distance between the wing-attachment points on either side of the thorax). Cane (1987)’s model was developed with a sample of 20 single females from solitary bee species in North America that represented six major bee families. It is now the most commonly used metric for estimating bee body size (Web of Science: 89 citations, Google scholar: 108 citations) and has used in ecological (eg. Williams et al. 2010), sensory (e.g. Spaethe & Chittka 2003; Kapustjanskij et al. 2007) and behavioural studies (e.g. Oliveira & Schlindwein 2010). It has also been used to quantify other ecologically important allometric relationships (e.g. foraging range and bee proboscis length; Greenleaf et al. 2007; Cariveau et al. 2016).

Despite its widespread use, it is time to update Cane (1987)’s model in order to enhance the use of predictive allometry for pollinating insects. Specifically, the following factors should be addressed and accounted for: i) small sample size that excludes social bees and restricted taxa (i.e. Strenotritidae), ii) use of preserved museum specimens, and iii) biogeographical limits of the sample. 

#Biogeographic influences 

Predictive allometric models exhibit well-known differences between both aquatic and terrestrial invertebrate taxa, as well as between larval and adult growth stages, hypothetically, due to differing life histories and ontogenetic constraints (Martin et al. 2014). As adult terrestrial invertebrates are the predominant pollinating taxa, we exclude aquatic-terrestrial and larval-adult differences.

Terrestrial invertebrates show considerable geographic variation in shape and form. Body length- mass accumulation rates change over a latitudinal gradient; the rate of body mass/length accumulation increasing with absolute latitude. This may reflect a biogeographic gradient of increased predation pressure toward the tropics (Martin et al. 2014). The presence of larger, comparatively lighter insects in the tropics lends support for the ‘index of bizarreness’ hypothesis (Schoener 1980; Johnson & Strong 2000) whereby larger insects are disproportionately slender due to predation pressure. Increased body mass is associated with a greater cost for both running (Garland 1983) and flying (Marden 1994). As such, slenderness may enable greater predator avoidance and/or fleeing. Crucially, this latitudinal gradient may also be the result of other well-known environmental and ecological gradients, such as primary productivity, niche width, metabolic rate and climate (Martin et al. 2014). How these contribute to this variation in mass-accumulation remains unanswered. There has been considerable under-sampling in mid-latitude arid zones, and this hinders further analyses of causes underpinning latitudinal trends in mass accumulation.

The latitudinal gradient in length-mass models suggests comparable geographic regions (i.e. temperate regions) should exhibit similar allometric trends. However, length-mass models can differ considerably both between and within comparable geographical regions. For example, Rogers et al. (1977) constructed length-mass models for shrub-steppe invertebrates in North America. Remarkably, Gowing & Recher (1984) found their allometric models from both eucalypt forests and woodlands in NSW, Australia, did not differ from Rogers et al. (1977), with the exception of Hymenoptera. However, Schoener (1980) found systemic differences between their models (between two forest types in Costa Rica, and temperate forest in Massachusetts, USA) and those of Rogers et al. (1977). As such, consideration for the specific environmental conditions of differing populations/communities, i.e. ecosystem type (forest, shrub-steppe) is important when constructing predictive allometric models, even in comparable climactic zones or geographic regions. The use of specimens from multiple biogeographic areas in model fitting may provide an avenue to overcome this limitation. 


###METHODOLOGY

##Existing equations

We selected three key pollinating insect orders: Diptera, Hymenoptera and Lepidoptera and collated all known predictive allometric models using a systematic literature search. These represent a large selection of taxa and have a wide representation of different biogeographic regions and continental landmasses. These include both simple (body length or intertegular span) and complex models such as the multivariate regression model for Lepidoptera devised by Garcia-Barros (2015).

##Specimen collection and curation

Only curated or fresh undamaged specimens were included for analysis. For every included specimen, we obtained preservative time, collection location (latitude and longitude) and collection method (pan trap, sweeping, malaise trap). 


##Trait measurement

#Body size
Dry mass (mg), herein body size, was measured on an analytical balance with an accuracy to 0.001g. Both fresh and curated specimens were dehydrated at 70 degrees celsius for 24-48h prior to weighing to remove residual humidity as moisture can contribute to measurement error (INSREF). 
Specimen pins were not removed prior to weighing. Rather pin type and brand was identified, a sample of 10-50 pins per type and brand were measured and the mean substracted off total weight.

#Intertegular distance
Intertegular distance was measured in millimetres using a stereo-microscope, either mounted with a scale and micrometer or a camera.




#Statistics - Model structure

We included 'measurement' which denoted the measurer as well as each instrument as a random term.

Measurement - Included as random effect, the measurer + instrument so my measurements in Aus and Switz are two different levels.
We exclude latitude and climatic zone from analyses as given the geographic distribution of specimens, we cannot discount sampling biases.


#Testing of confounding factor - preservative time

Using data-sets from Australia and Germany which exhibited species-overlap in preservative time, we tested this influence upon body size using a linear model. Preservative time was found to exhibit some influence (XXX), which accounted for a loss of 0.006mg per day preserved. As such, it was not considered integral to account for such a small loss (SUPP INFORMATION). 

##Model selection

We fitted a mixed-effect model with all predicted explanatory variables (family, region, sex and their interactions with ITD) and measurement as a random term. We then performed model selection using all subset models using the dredge function within the R library MuMIn (REF). This was repeated for models which included biogeographic region and without. Final model was selected on the basis of AIC.

We then used cross-validation to assess model bias. We split our data frame into 80/20 training, test split, re-run the best model using the training set and compared relative mean square error between predicted value of the test set against real values. Such an approach was repeated for all provided models as well as against pre-exisitng equations (i.e. Cane 1989).

##Results

#Existing equations


Diptera: 26 allometric models for Diptera were collated (Table 1A). 11 models were reported for the entire order, including nine without any taxonomic breakdown of samples used. 11 for the three main suborders Nematocera (6), Brachycera (4) and Cycllorapha (2) and two for specific families; Asilidae and Bombyliidae. Surprisingly, there were no equations for Syrphidiae, a key pollinating taxa in many ecosystems (eg. Biesmeijer et al. 2006, Jauker et al. 2012) 

Hymenoptera: 38 allometric models for Hymenoptera were collated (Table 1B). These included eight combined, seven excluding ants (Formicidae) (7) as well as ten for Formicidae. There are three equations for Vespidae and two equations for Apidae (Cane 1987 & Sabo et al. (2002). Only Sample et al’s (1993) body length and body length*width equations are provided for Braconidae, Ichneumonidae, Halictidae and Pompilidae.

Lepidoptera: 21 allometric models for Lepidoptera were collated (Table 1C). This includes 13 with varying taxa and without lower classifications. Hodar (1997) provides specific models for Heterocera (moths) and Ropalocera (butterflies). Sample et al. (1993) provide BL and BL*BW models for Microlepidoptera and two moth families Geometridae and Arctiidae. A multivariate regression model using specimens from 61 Lepidoptera families is also included (Garcia-Barros 2015).

#Testing of key co-variates

  - I think proper syntax is WEIGHT ~ SPECIES + PRES.TIME (or Species*Pres.time?) or WGT ~ Pres.time + (1|Species)?

Overall, preservative time accounted for a decrease in -0.006mg per day. 
##Results

#Existing equations


Diptera: 26 allometric models for Diptera were collated (Table 1A). 11 models were reported for the entire order, including nine without any taxonomic breakdown of samples used. 11 for the three main suborders Nematocera (6), Brachycera (4) and Cycllorapha (2) and two for specific families; Asilidae and Bombyliidae. Surprisingly, there were no equations for Syrphidiae, a key pollinating taxa in many ecosystems (eg. Biesmeijer et al. 2006, Jauker et al. 2012) 

Hymenoptera: 38 allometric models for Hymenoptera were collated (Table 1B). These included eight combined, seven excluding ants (Formicidae) (7) as well as ten for Formicidae. There are three equations for Vespidae and two equations for Apidae (Cane 1987 & Sabo et al. (2002). Only Sample et al’s (1993) body length and body length*width equations are provided for Braconidae, Ichneumonidae, Halictidae and Pompilidae.

Lepidoptera: 21 allometric models for Lepidoptera were collated (Table 1C). This includes 13 with varying taxa and without lower classifications. Hodar (1997) provides specific models for Heterocera (moths) and Ropalocera (butterflies). Sample et al. (1993) provide BL and BL*BW models for Microlepidoptera and two moth families Geometridae and Arctiidae. A multivariate regression model using specimens from 61 Lepidoptera families is also included (Garcia-Barros 2015).

##SUPP##Preservative time - Australia and Germany only

We tested the effect of time in preservative (70-100% ethanol) on Australian and Germany bee samples in specimens differed in preservative length. In total, we had 20 bee species which had been subjected to different lengths within ethanol.

  - I think proper syntax is WEIGHT ~ SPECIES + PRES.TIME (or Species*Pres.time?) or WGT ~ Pres.time + (1|Species)?

Overall, preservative time accounted for a decrease in -0.006mg per day. 


```{r}

pres.lm=lm(Spec.wgt~Species+Pres.time,bee_pres)

summary(pres.lm)
```

```{r}

pres.lme=lmer(Spec.wgt~Pres.time+(1|Species)+(1|Country),bee_pres)
summary(pres.lme)
```

#Model choice

Test lme models /w and /wo biogeography.

#With region
```{r}

options(na.action = "na.fail")
bee_f_lme=lmer(log(Spec.wgt) ~ log(IT)  + Family + Sex + Region + #fix factors
                              log(IT):Family + log(IT):Region + log(IT):Sex + #interactions
                              (1|Measurement),REML=FALSE,bee_mean)

bee_dr_lme=dredge(bee_f_lme,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(bee_dr_lme)

```
#Without region

```{r}

bee_f_lme_red=lmer(log(Spec.wgt) ~ log(IT)  + Family + Sex  + #fix factors
                 log(IT):Family + log(IT):Sex + #interactions
                 (1|Measurement),REML=FALSE,bee_mean)

options(na.action = "na.fail")
bee_dr_lme_red=dredge(bee_f_lme_red,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(bee_dr_lme_red)


```

In both cases, the full model is retained. However, the difference in AIC is considerable (421.9 /w region vs. 479 /wo).



Let us test this for Europe once we have Belgian data as we will have good range.

=======
#Phylogenetic GLS

Here we can do two things: 1) check traits themselves and Wgt~IT, and 2) run with intraspecific variation for species we have more than one specimen (pgls.Ives (phytools))

```{r}

p=ggtree((bee_pruned))
p + geom_tiplab(size=3)

```

##Individual traits

Both body size and intertegular span showed a high phylogenetic signal (BS: \( \lambda \) 0.81, lnBS:\( \lambda \) 0.78, IT: \( \lambda \) 0.82, lnIT: \( \lambda \) 0.8). Based on AIC, the PGLS better described the relationship between BS and IT than gls (AIC pgls: 268 ~ gls: 288).

#Spec.wgt

```{r}

bee_phylo_WGT=as.data.frame(bee_phylo[,c("Spec.wgt")])
rownames(bee_phylo_WGT)=rownames(bee_phylo)

WGT_phylo=fitContinuous(bee_pruned, (bee_phylo_WGT),SE=0,
              model = c("lambda"))
WGT_phylo

WGT_phylo_log=fitContinuous(bee_pruned, log(bee_phylo_WGT),SE=0,
              model = c("lambda"))
WGT_phylo_log
```

##Intertegular distance

```{r}

bee_phylo_IT=as.data.frame(bee_phylo[,c("IT")])
rownames(bee_phylo_IT)=rownames(bee_phylo)

IT_phylo=fitContinuous(bee_pruned, bee_phylo_IT,SE=0,
              model = c("lambda"))
IT_phylo

IT_phylo_log=fitContinuous(bee_pruned, log(bee_phylo_IT),SE=0,
              model = c("lambda"))
IT_phylo_log
```


##Predictive model
#SPEC.WGT ~ IT


```{r}
#first compute correlation matrix from tree
Bee_vcv=corPagel(value=0.5,phy=bee_pruned,fixed=FALSE)

Bee_GLS1<- gls(log(Spec.wgt)~log(IT), data=bee_phylo, method="ML")
summary(Bee_GLS1)

Bee_PGLS1 = gls(log(Spec.wgt)~log(IT), data=bee_phylo, correlation=Bee_vcv, method="ML")
summary(Bee_PGLS1)

AIC(Bee_GLS1,Bee_PGLS1)


```

Together, lower lambda but good result nonetheless. Suggests a non-PGLS model may be better at predicting body size even if both BS and IT have phylo-signal. The evolution of bee body size is fascinating though.

https://besjournals.onlinelibrary.wiley.com/doi/pdf/10.1111/j.2041-210X.2012.00196.x
  This paper is great for understanding the different phylo models.
  
```{r,echo=FALSE}

WGT=as.data.frame(log(bee_phylo[,c("Spec.wgt")]))
rownames(WGT)=rownames(bee_phylo)
WGT<-as.matrix((WGT))[,1]
obj<-contMap((bee_pruned),WGT,fsize=c(0.5,0.5),outline=FALSE)

```

##Intraspecific variation
To assess intraspecific variation in trait mesaurements. We plotted mean against increasing sample size to estimate the adequate sample size whereby mean variance stabilised.

Plotted for five most speciose species: Homalictus urbanus (n = 250), Lasioglossum pauxillum (n = ), Bombus lucorum (n = ), Andrena flavipes (n = ) and Lasioglossum lanarium (n = . 


```{r,echo=FALSE}
#Homalictus_urbanus
#Lasioglossum_pauxillum
#Bombus_lucorum
#Andrena_flavipes
#Lasioglossum_lanarium

bee_species=split(bee_all,bee_all$Species)

##ONE##
#Homalictus_urbanus
#IT
HU_IT = c()
for(i in 1:length(bee_species$Homalictus_urbanus$IT)){
  subset1 = sample(bee_species$Homalictus_urbanus$IT, i)
  HU_IT[i] = mean(subset1)
}

#Specimen weight
HU_WT = c()
for(i in 1:length(bee_species$Homalictus_urbanus$Spec.wgt)){
  subset1 = sample(bee_species$Homalictus_urbanus$Spec.wgt, i)
  HU_WT[i] = mean(subset1)
}


##TWO##

#Lasioglossum_pauxillum
#IT
LP_IT = c()
for(i in 1:length(bee_species$Lasioglossum_pauxillum$IT)){
  subset1 = sample(bee_species$Lasioglossum_pauxillum$IT, i)
  LP_IT[i] = mean(subset1)
}

#Specimen weight
LP_WT = c()
for(i in 1:length(bee_species$Lasioglossum_pauxillum$Spec.wgt)){
  subset1 = sample(bee_species$Lasioglossum_pauxillum$Spec.wgt, i)
  LP_WT[i] = mean(subset1)
}

##THREE
#Bombus_lucorum
BL_IT = c()
for(i in 1:length(bee_species$Bombus_lucorum$IT)){
  subset1 = sample(bee_species$Bombus_lucorum$IT, i)
  BL_IT[i] = mean(subset1)
}

#Specimen weight
BL_WT = c()
for(i in 1:length(bee_species$Bombus_lucorum$Spec.wgt)){
  subset1 = sample(bee_species$Bombus_lucorum$Spec.wgt, i)
  BL_WT[i] = mean(subset1)
}

##FOUR##
#Andrena_flavipes
#IT
AF_IT = c()
for(i in 1:length(bee_species$Andrena_flavipes$IT)){
  subset1 = sample(bee_species$Andrena_flavipes$IT, i)
  AF_IT[i] = mean(subset1)
}

#Specimen weight
AF_WT = c()
for(i in 1:length(bee_species$Andrena_flavipes$Spec.wgt)){
  subset1 = sample(bee_species$Andrena_flavipes$Spec.wgt, i)
  AF_WT[i] = mean(subset1)
}

##FIVE##
#Lasioglossum_lanarium
LL_IT = c()
for(i in 1:length(bee_species$Lasioglossum_lanarium$IT)){
  subset1 = sample(bee_species$Lasioglossum_lanarium$IT, i)
  LL_IT[i] = mean(subset1)
}


#Specimen weight
LL_WT = c()
for(i in 1:length(bee_species$Lasioglossum_lanarium$Spec.wgt)){
  subset1 = sample(bee_species$Lasioglossum_lanarium$Spec.wgt, i)
  LL_WT[i] = mean(subset1)
}

##graphed three for aesthetics based on size range
par(mfrow=c(2,3))
par(pty="s")
plot(HU_IT,main="Homalictus urbanus",ylab = "ITD (mm)",xlab="")
#plot(LP_IT,main="Lasioglossum pauxillum",ylab = "",xlab="")
plot(AF_IT,main="Andrena flavipes",ylab = "",xlab="")
plot(BL_IT,main="Bombus lucorum",ylab = "",xlab="")

#plot(LL_IT,main="Lasioglossum lanarium",ylab = "",xlab="Sample size")

plot(HU_WT,ylab = "Specimen weight (mg)",xlab="Sample size")
#plot(LP_WT,ylab = "",xlab="Sample size")
plot(AF_WT,ylab = "",xlab="Sample size")
plot(BL_WT,ylab = "",xlab="Sample size")

#plot(LL_WT,ylab = "",xlab="Sample size")

```

#Model validation

##Training and test set

##Bootstrap - not currently possible for lme so back to train/test

```{r}
library(ModelMetrics)
set.seed(123)
bee_subset=sample(seq_len(nrow(bee_mean)), size = floor(0.8 * nrow(bee_mean)))
bee_test <- bee_mean[-bee_subset, ]
bee_train <- bee_mean[bee_subset, ]

Cane <- function(IT){exp(0.6453 + 2.4691*log(IT))}


bee_test_mod=lmer(log(Spec.wgt) ~ log(IT)  + Family + Sex + Region + #fix factors
                              log(IT):Family + log(IT):Region + log(IT):Sex + #interactions
                              (1|Measurement),data=bee_train,REML=FALSE)
bee_test_red_mod=lmer(formula = log(Spec.wgt) ~ log(IT) + Family + Sex + log(IT):Family + 
    log(IT):Sex + (1 | Measurement), data = bee_train, REML = FALSE)

bee_test_red_mod2=lmer(formula = log(Spec.wgt) ~ log(IT) + (1 | Measurement), data = bee_train, REML = FALSE)

bee_pred1=predict(bee_test_mod,newdata=bee_test)
bee_pred2=predict(bee_test_red_mod,newdata=bee_test)
bee_pred3=predict(bee_test_red_mod2,newdata=bee_test)
bee_pred4=0.6453 + 2.4691*log(bee_test$IT)
bee_pred5=predict(Bee_PGLS1,newdata=bee_test)
par(pty="s")
par(mfrow=c(1,2))
plot((IT)~(Spec.wgt),bee_train,ylab="Specimen weight (mg)",xlab="ITD (mm)")
points((bee_test$IT)~exp(bee_pred1),col=2)
points((bee_test$IT)~exp(bee_pred2),col=3)


plot((IT)~(Spec.wgt),bee_train,ylab="Specimen weight (mg)",xlab="ITD (mm)")
points((bee_test$IT)~exp(bee_pred3),col=4)
points((bee_test$IT)~exp(bee_pred4),col=5)
points((bee_test$IT)~exp(bee_pred5),col=6)
bee_rmse=cbind(
rmse(log(bee_test$Spec.wgt),bee_pred1),
rmse(log(bee_test$Spec.wgt),bee_pred2),
rmse(log(bee_test$Spec.wgt),bee_pred3),
rmse(log(bee_test$Spec.wgt),bee_pred4),
rmse(log(bee_test$Spec.wgt),bee_pred5))
colnames(bee_rmse)=c("Full","Reduced","IT","Cane","PGLS")
rownames(bee_rmse)=c("RMSE")
bee_rmse
```

Cane is good, ours is slightly better - good validation of Cane though!! Our data captures natural variability and slight differences between families esp. Apidae vs. the rest

Dan is providing data in next couple of weeks.

I think phylo-signal of body size / IT is cool / interesting angle. Not sure if individual traits need to be log-transformed for signal

Perhaps use Nico's input for focus on phylogeny - I am finding phylo singal (Pagel's lambda) is high but there are methodological considerations I cannot fix yet
  - whether or not the tree used is ultrametric or not
  - including subgenera - binding trees where phylogeny is well-resolved i.e. adding bombus tree would be ace - from my understanding lambda is robust to this

Here we can do two things: 1) check traits themselves and Wgt~IT, and 2) run with intraspecific variation for species we have more than one specimen (pgls.Ives (phytools)) - still working this out - it has annoying input but so does geiger


#####Hoverflies

```{r}
hov_all=poll_all_split[[2]]

options(na.action=na.omit)
hov_mean=aggregate(Latitude~Family+Tribe+Country+
                     Region+Measurement+Subfamily+Genus+Species+Sex,hov_all,mean)
hov_mean$Longitude=aggregate(Longitude~Family+Tribe+Country+
                     Region+Measurement+Subfamily+Genus+Species+Sex,hov_all,mean)[10]

hov_mean$Spec.wgt=as.numeric(unlist(aggregate(Spec.wgt~Family+Tribe+Country+
                                                Region+Measurement+Subfamily+
                                                Genus+Species+Sex,hov_all,mean)[10]))
hov_mean$IT=as.numeric(unlist(aggregate(IT~Family+Tribe+Country+
                                          Region+Measurement+Subfamily+
                                          Genus+Species+Sex,hov_all,mean)[10]))
##Full
hov.full=lmer(log(Spec.wgt) ~ log(IT) + Region+ Sex + Subfamily+ #fix
            log(IT):Sex + #interactions
            log(IT):Subfamily + log(IT):Region+ (1|Measurement)
            ,REML=FALSE,data=hov_mean)
##/wo region
hov.red=lmer(log(Spec.wgt) ~ log(IT) + Sex + Subfamily+ #fix
            log(IT):Sex + #interactions
            log(IT):Subfamily + (1|Measurement)
            ,REML=FALSE,data=hov_mean)

##DREDGE
options(na.action = "na.fail")

hov_dr=dredge(hov.full,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(hov_dr)

hov_dr_red=dredge(hov.red,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(hov_dr_red)
```

#Model validation - hoverflies

##Training and test set

##Bootstrap - not currently possible for lme so back to train/test

```{r}
library(ModelMetrics)
set.seed(123)
hov_subset=sample(seq_len(nrow(hov_mean)), size = floor(0.8 * nrow(hov_mean)))
hov_test <- hov_mean[-hov_subset, ]
hov_train <- hov_mean[hov_subset, ]

hov_test_mod=lmer(formula = log(Spec.wgt) ~ log(IT) + Region + Sex + Subfamily + 
    log(IT):Sex + log(IT):Subfamily + log(IT):Region + (1 | Measurement), 
    data = hov_train, REML = FALSE)
hov_test_red_mod=lmer(formula = log(Spec.wgt) ~ log(IT) + Sex + Subfamily + log(IT):Sex + 
    log(IT):Subfamily + (1 | Measurement), data = hov_train, REML = FALSE)

hov_test_red_mod2=lmer(formula = log(Spec.wgt) ~ log(IT) + (1 | Measurement), data = hov_train, REML = FALSE)

hov_pred1=predict(hov_test_mod,newdata=hov_test)
hov_pred2=predict(hov_test_red_mod,newdata=hov_test)
hov_pred3=predict(hov_test_red_mod2,newdata=hov_test)

par(pty="s")
plot((IT)~Spec.wgt,hov_train,ylab="ln Specimen weight (mg)",xlab="ln ITD (mm)")
points((hov_test$IT)~exp(hov_pred1),col=2)
points((hov_test$IT)~exp(hov_pred2),col=3)
points((hov_test$IT)~exp(hov_pred3),col=4)



hov_rmse=cbind(rmse(log(hov_test$Spec.wgt),hov_pred1),
rmse(log(hov_test$Spec.wgt),hov_pred2),
rmse(log(hov_test$Spec.wgt),hov_pred3))
colnames(hov_rmse)=c("Full","Reduced","IT")
rownames(hov_rmse)=c("RMSE")
hov_rmse
```


##Intraspecific variation in hoverflies

Top five species: Helophilus parallelus (n = 19), Sphaerophoria macrogaster (n = 17),
Episyrphus balteatus (n = 15), Melanostoma mellinum (n = 12) and Syritta pipiens (n = 12).
```{r,echo=FALSE}

##ONE##
#Helophilus_parallelus
#IT
HHP_IT = c()
for(i in 1:length(hov_species$Helophilus_parallelus$IT)){
  subset1 = sample(hov_species$Helophilus_parallelus$IT, i)
  HHP_IT[i] = mean(subset1)
}

#Specimen weight
HHP_WT = c()
for(i in 1:length(hov_species$Helophilus_parallelus$Spec.wgt)){
  subset1 = sample(hov_species$Helophilus_parallelus$Spec.wgt, i)
  HHP_WT[i] = mean(subset1)
}


##TWO##

#Sphaerophoria_macrogaster
#IT
HSM_IT = c()
for(i in 1:length(hov_species$Sphaerophoria_macrogaster$IT)){
  subset1 = sample(hov_species$Sphaerophoria_macrogaster$IT, i)
  HSM_IT[i] = mean(subset1)
}

#Specimen weight
HSM_WT = c()
for(i in 1:length(hov_species$Sphaerophoria_macrogaster$Spec.wgt)){
  subset1 = sample(hov_species$Sphaerophoria_macrogaster$Spec.wgt, i)
  HSM_WT[i] = mean(subset1)
}

##THREE
#Episyrphus_balteatus
HEB_IT = c()
for(i in 1:length(hov_species$Episyrphus_balteatus$IT)){
  subset1 = sample(hov_species$Episyrphus_balteatus$IT, i)
  HEB_IT[i] = mean(subset1)
}

#Specimen weight
HEB_WT = c()
for(i in 1:length(hov_species$Episyrphus_balteatus$Spec.wgt)){
  subset1 = sample(hov_species$Episyrphus_balteatus$Spec.wgt, i)
  HEB_WT[i] = mean(subset1)
}

##FOUR##
#Melanostoma_mellinum
#IT
HMM_IT = c()
for(i in 1:length(hov_species$Melanostoma_mellinum$IT)){
  subset1 = sample(hov_species$Melanostoma_mellinum$IT, i)
  HMM_IT[i] = mean(subset1)
}

#Specimen weight
HMM_WT = c()
for(i in 1:length(hov_species$Melanostoma_mellinum$Spec.wgt)){
  subset1 = sample(hov_species$Melanostoma_mellinum$Spec.wgt, i)
  HMM_WT[i] = mean(subset1)
}

##FIVE##
#Syritta_pipiens
HSP_IT = c()
for(i in 1:length(hov_species$Syritta_pipiens$IT)){
  subset1 = sample(hov_species$Syritta_pipiens$IT, i)
  HSP_IT[i] = mean(subset1)
}


#Specimen weight
HSP_WT = c()
for(i in 1:length(hov_species$Syritta_pipiens$Spec.wgt)){
  subset1 = sample(hov_species$Syritta_pipiens$Spec.wgt, i)
  HSP_WT[i] = mean(subset1)
}

##graphed three for aesthetics based on size range
par(mfrow=c(2,3))
par(pty="s")
plot(HHP_IT,main="Helophilus parallelus",ylab = "ITD (mm)",xlab="")
plot(HSM_IT,main="Sphaerophoria macrogaster",ylab = "",xlab="")
plot(HEB_IT,main="Episyrphus balteatus",ylab = "",xlab="Sample size")
#plot(HMM_IT,main="Melanostoma_mellinum",ylab = "",xlab="")
#plot(HSP_IT,main="Syritta_pipiens",ylab = "",xlab="Sample size")

plot(HHP_WT,ylab = "Specimen weight (mg)",xlab="Sample size")
plot(HSM_WT,ylab = "",xlab="Sample size")
plot(HEB_WT,ylab = "",xlab="Sample size")
#plot(HMM_WT,ylab = "",xlab="Sample size")
#plot(HSP_WT,ylab = "",xlab="Sample size")
```