---
title: 'Pollimetry: Predictive allometry for pollinating insects'
author: Liam Kendall, Romina Rader, Vesna Gagic, Daniel Cariveau, Matthias Albrecht, Katherine Baldock, Juanita Rodriguez, Louis Suter and Ignasi Bartomeus
date: "18/05/2018"
output: pdf_document
---

This markdown file has all code from the MS so you can look over it, notice any issues/mistakes and make changes :)

#Data preparation
```{r setup, include=FALSE}  
knitr::opts_chunk$set(echo = TRUE)
library(broom)
library(grid)
library(gridExtra)
library(lme4)
library(nlme)
library(ModelMetrics)
library(MuMIn)
library(foreign)
library(compiler)
library(parallel)
library(phytools)
library(plyr)
library(dplyr)
library(tidyverse)

#dataframe
set.seed(123)
poll_all <- read.csv(file="data/PA120518.csv",header=T)

#split to bees and hoverflies
poll_all$Spec.wgt=poll_all$Spec.wgt*1000
poll_all_split=split(poll_all,poll_all$Superfamily)
bee_all=poll_all_split[[1]]
hov_all=poll_all_split[[2]]

#JUST AUSTRALIA
bee_country=split(bee_all,bee_all$Country)
bee_australia=bee_country$Australia

##BEE mean dataframe
bee_mean=aggregate(Latitude~Family+Subfamily+Tribe+Region+Country+Measurement+Subfamily+Genus+Species+Sex,bee_all,mean)
bee_mean$Spec.wgt=as.numeric(unlist(aggregate(Spec.wgt~Family+Country+Subfamily+Tribe+Region+Measurement+
                                                Subfamily+Genus+Species+Sex,bee_all,mean)[10]))
bee_mean$IT=(as.numeric(unlist(aggregate(IT~Family+Subfamily+Tribe+Region+Country+
                                         Measurement+Subfamily+Genus+Species+Sex,bee_all,mean)[10])))

##HOV mean dataframe
hov_all=poll_all_split[[2]]

options(na.action=na.omit)
hov_mean=aggregate(Latitude~Family+Tribe+Country+
                     Region+Measurement+Subfamily+Genus+Species+Sex,hov_all,mean)
hov_mean$Longitude=aggregate(Longitude~Family+Tribe+Country+
                     Region+Measurement+Subfamily+Genus+Species+Sex,hov_all,mean)[10]

hov_mean$Spec.wgt=as.numeric(unlist(aggregate(Spec.wgt~Family+Tribe+Country+
                                                Region+Measurement+Subfamily+
                                                Genus+Species+Sex,hov_all,mean)[10]))
hov_mean$IT=as.numeric(unlist(aggregate(IT~Family+Tribe+Country+
                                          Region+Measurement+Subfamily+
                                          Genus+Species+Sex,hov_all,mean)[10]))


##PHYLO Dataframe
bee_phylo=aggregate(Latitude~Region+Family+Subfamily+
                        Tribe+Genus+Species,bee_all,median)
bee_phylo$Longitude=as.numeric(unlist(aggregate(Longitude~Region+Family+Subfamily+
                                                    Tribe+Genus+Species,bee_all,median)[7]))
bee_phylo$Spec.wgt=as.numeric(unlist(aggregate(Spec.wgt~Region+Family+Subfamily+
                                                   Tribe+Genus+Species,bee_all,mean)[7]))
bee_phylo$Wgt.SD=as.numeric(unlist(aggregate(log(Spec.wgt)~Region+Family+Subfamily+
                                                 Tribe+Genus+Species,bee_all,sd)[7]))
bee_phylo$IT=as.numeric(unlist(aggregate(IT~Region+Family+Subfamily+
                                             Tribe+Genus+Species,bee_all,mean)[7]))
bee_phylo$IT.SD=as.numeric(unlist(aggregate(log(IT)~Region+Family+Subfamily+
                                                Tribe+Genus+Species,bee_all,sd)[7]))

##REMOVE DUPLICATES FROM REGIONS
#Apis from Australia
#Halictus rubicundus from NA
#Flavipanurgus as not in phylogeny
#duplicated(bee_phylo$Species)

bee_phylo[121,]
bee_phylo[114,]
bee_phylo[55,]

bee_phylo=bee_phylo[-121,]
bee_phylo=bee_phylo[-114,]
bee_phylo=bee_phylo[-55,]

rownames(bee_phylo)=bee_phylo$Species

##Bee phylogeny
bee.phy=read.tree(file="raw_data/Bee_phylogeny_Hedtke_etal2013/12862_2013_2375_MOESM3_ESM.txt",keep.multi = TRUE)
##Use tree 1 (376 genera) #Genera-level phylogney
bee.phy=bee.phy[[1]]
bee.phy=as.phylo(bee.phy)
bee.phy=root(bee.phy,outgroup="Tachysphex")
#bee.phy=force.ultrametric(bee.phy) Not sure if this is required
bee_pruned=drop.tip(bee.phy, setdiff(bee.phy$tip.label,bee_phylo$Genus))
bee_pruned=genus.to.species.tree(bee_pruned, species=bee_phylo$Species)


##Intraspecific variance data frames
bee_species=split(bee_all,bee_all$Species)
hov_species=split(hov_all,hov_all$Species)

#Preservative time data frame

#JUST AUST and GER
bee_country=split(bee_all,bee_all$Country)
bee_pres=rbind(bee_country$Australia,bee_country$Germany)

#Filter so only species with more than 1 preservative time
bee_pres=as.data.frame(bee_pres %>%
  group_by(Species) %>% 
  filter(n_distinct(Pres.time)>1))

##Cane function
Cane=function(IT){exp(0.6453 + 2.4691*log(IT))}
```

##Bee model selection
Test lme models w. biogeography.
```{r} 

options(na.action = "na.fail")
bee_f_lme=lmer(log(Spec.wgt) ~ log(IT)  + Family + Sex + Region + #fix factors
                              log(IT):Family + log(IT):Region + log(IT):Sex + #interactions
                              (1|Measurement)+(1|Species),REML=FALSE,bee_mean)

bee_dr_lme=dredge(bee_f_lme,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(bee_dr_lme)
```

Repeat without region
```{r}

options(na.action = "na.fail")
bee_fe_lme=lmer(log(Spec.wgt) ~ log(IT)  + Family + Sex + #fix factors
                              log(IT):Family + log(IT):Sex + #interactions
                              (1|Measurement)+(1|Species),REML=FALSE,bee_mean)

bee_de_lme=dredge(bee_fe_lme,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(bee_de_lme)
```

And without region and sex
```{r}

options(na.action = "na.fail")
bee_fes_lme=lmer(log(Spec.wgt) ~ log(IT)  + Family  + #fix factors
                              log(IT):Family + #interactions
                              (1|Measurement)+(1|Species),REML=FALSE,bee_mean)

bee_des_lme=dredge(bee_fes_lme,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(bee_des_lme)
```

Just ITD
```{r,echo=FALSE}

bee_IT_lme=lmer(log(Spec.wgt) ~ log(IT) +
                              (1|Measurement)+(1|Species),REML=FALSE,bee_mean)
AIC(bee_IT_lme)
```

#TBC - within region
Let us test this for Europe once we have Belgian data as we will have good range.

#Hoverfly model selection
Test w. biogeography
```{r}

##Full
hov.full=lmer(log(Spec.wgt) ~ log(IT) + Region+ Sex + Subfamily+ #fix
            log(IT):Sex + #interactions
            log(IT):Subfamily + log(IT):Region+ (1|Measurement)+(1|Species)
            ,REML=FALSE,data=hov_mean)

options(na.action = "na.fail")
hov_dr=dredge(hov.full,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(hov_dr)
```

And without sex

```{r}
hov.red=lmer(log(Spec.wgt) ~ log(IT) + Subfamily + #interactions
            log(IT):Subfamily + (1|Measurement)+(1|Species)
            ,REML=FALSE,data=hov_mean)

hov_dr_red=dredge(hov.red,beta="none",rank="AIC") #think about "sd" and "AICc". AIC show same pattern.
head(hov_dr_red)
```

#Phylogenetic GLS - BEES

https://besjournals.onlinelibrary.wiley.com/doi/pdf/10.1111/j.2041-210X.2012.00196.x
  This paper is great for understanding the different phylo models

#Individual traits
  - not in MS at the moment but both significant as correlated
  Spec.wgt
```{r}
WGT=as.data.frame(bee_phylo[,c("Spec.wgt")])
WGT=log(WGT)
rownames(WGT)=rownames(bee_phylo)
WGT<-as.matrix((WGT))[,1]
phylosig(tree=bee_pruned,x=WGT,method="lambda",test=TRUE)

```
```{r}
bee_wgt_phy=contMap(bee_pruned,WGT,plot=FALSE)
plot(bee_wgt_phy,fsize=c(0.4,1),lwd=0.75,leg.txt="log(WGT)")
```
  Intertegular distance
```{r}
IT=as.data.frame(bee_phylo[,c("IT")])
IT=log(IT)
rownames(IT)=rownames(bee_phylo)
IT<-as.matrix((IT))[,1]
phylosig(tree=bee_pruned,x=IT,method="lambda",test=TRUE)

```

#PGLS

SPEC.WGT ~ IT * Region and subsets - compared against standard GLS for reference

```{r}  

#standard gls

Bee_GLS1<- gls(log(Spec.wgt)~log(IT)*Region, data=bee_phylo,
               method="ML")

Bee_GLS2<- gls(log(Spec.wgt)~log(IT)+Region, data=bee_phylo,
               method="ML")

Bee_GLS3<- gls(log(Spec.wgt)~log(IT), data=bee_phylo,
               method="ML")

#PGLS
#compute correlation matrix from tree
Bee2vcv=corPagel(value=0.5,phy=bee_pruned,fixed=FALSE)

Bee_PGLS1 = gls(log(Spec.wgt)~log(IT)*Region, data=bee_phylo, 
                correlation=Bee2vcv, method="ML")

Bee_PGLS2 = gls(log(Spec.wgt)~log(IT)+Region, data=bee_phylo, 
                correlation=Bee2vcv, method="ML")

Bee_PGLS3 = gls(log(Spec.wgt)~log(IT), data=bee_phylo, 
                correlation=Bee2vcv, method="ML")

Bee_PGLS1
Bee_PGLS2
Bee_PGLS3
AIC(Bee_GLS1,Bee_GLS2,Bee_GLS3,Bee_PGLS1,Bee_PGLS2,Bee_PGLS3)

AIC(Bee_GLS1)-AIC(Bee_PGLS1)
AIC(Bee_GLS2)-AIC(Bee_PGLS2)
AIC(Bee_GLS3)-AIC(Bee_PGLS3)
dredge(Bee_PGLS1,rank="AIC")

```

#Phylogenetic GLS - HOVERFLIES

EMPTY - waiting on current phylogeny

#Model validation - k-fold cross validation

Bees
```{r}  
#libraries

##Create fold function for LME and PGLS

fold_cv=function(data,k){
  folds=cvTools::cvFolds(nrow(data),K=k)
  invisible(folds)
}

set.seed(123)
fold<-bee_mean%>%fold_cv(.,k=5)

##WITH REGION
model1<-bee_mean%>%mutate(Fold=rep(0,nrow(bee_mean)),holdoutpred=rep(0,nrow(bee_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
  for(i in 1:5){
    train=model1[fold$subsets[fold$which != i], ]
    validation=model1[fold$subsets[fold$which == i], ]
    newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)  + Family + Sex  + Region+#fix factors
                       log(IT):Family  + log(IT):Sex + log(IT):Region+ #interactions
                       (1|Measurement)+(1|Species),data=train)
    newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
    true=log(validation$Spec.wgt)
    error=(true-newpred)
    rmse=sqrt(mean(error^2))
    mse=mean((newpred-true)^2)
    R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
    mae=mean(abs(error))
    model1[fold$subsets[fold$which == i], ]$holdoutpred <- newpred
    model1[fold$subsets[fold$which == i], ]$RMSE=rmse
    model1[fold$subsets[fold$which == i], ]$MSE=mse
    model1[fold$subsets[fold$which == i], ]$MAE=mae
    model1[fold$subsets[fold$which == i], ]$R2=R2
    model1[fold$subsets[fold$which == i], ]$AIC=AIC(newlm)
    model1[fold$subsets[fold$which == i], ]$BIC=BIC(newlm)
    model1[fold$subsets[fold$which == i], ]$Fold=i
  }


##Without sex
model2<-bee_mean%>%mutate(Fold=rep(0,nrow(bee_mean)),holdoutpred=rep(0,nrow(bee_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=model2[fold$subsets[fold$which != i], ]
  validation=model2[fold$subsets[fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)  + Family + Region  + Sex+ #fix factors
                     log(IT):Family  + log(IT):Region + #interactions
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  model2[fold$subsets[fold$which == i], ]$holdoutpred <- newpred
  model2[fold$subsets[fold$which == i], ]$RMSE=rmse
  model2[fold$subsets[fold$which == i], ]$MSE=mse
  model2[fold$subsets[fold$which == i], ]$MAE=mae
  model2[fold$subsets[fold$which == i], ]$R2=R2
  model2[fold$subsets[fold$which == i], ]$AIC=AIC(newlm)
  model2[fold$subsets[fold$which == i], ]$BIC=BIC(newlm)
  model2[fold$subsets[fold$which == i], ]$Fold=i
}


##Without sex
model3<-bee_mean%>%mutate(Fold=rep(0,nrow(bee_mean)),holdoutpred=rep(0,nrow(bee_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=model3[fold$subsets[fold$which != i], ]
  validation=model3[fold$subsets[fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)  + Family + Region  + #fix factors
                     log(IT):Family  + log(IT):Region + #interactions
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  model3[fold$subsets[fold$which == i], ]$holdoutpred <- newpred
  model3[fold$subsets[fold$which == i], ]$RMSE=rmse
  model3[fold$subsets[fold$which == i], ]$MSE=mse
  model3[fold$subsets[fold$which == i], ]$MAE=mae
  model3[fold$subsets[fold$which == i], ]$R2=R2
  model3[fold$subsets[fold$which == i], ]$AIC=AIC(newlm)
  model3[fold$subsets[fold$which == i], ]$BIC=BIC(newlm)
  model3[fold$subsets[fold$which == i], ]$Fold=i
}

##Without region
model4<-bee_mean%>%mutate(Fold=rep(0,nrow(bee_mean)),holdoutpred=rep(0,nrow(bee_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=model4[fold$subsets[fold$which != i], ]
  validation=model4[fold$subsets[fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)  + Family + Sex + #fix factors
                     log(IT):Family + log(IT):Sex + #interactions
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  model4[fold$subsets[fold$which == i], ]$holdoutpred <- newpred
  model4[fold$subsets[fold$which == i], ]$RMSE=rmse
  model4[fold$subsets[fold$which == i], ]$MSE=mse
  model4[fold$subsets[fold$which == i], ]$MAE=mae
  model4[fold$subsets[fold$which == i], ]$R2=R2
  model4[fold$subsets[fold$which == i], ]$AIC=AIC(newlm)
  model4[fold$subsets[fold$which == i], ]$BIC=BIC(newlm)
  model4[fold$subsets[fold$which == i], ]$Fold=i
}

##Without region and sex
model5<-bee_mean%>%mutate(Fold=rep(0,nrow(bee_mean)),holdoutpred=rep(0,nrow(bee_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=model5[fold$subsets[fold$which != i], ]
  validation=model5[fold$subsets[fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)  + Family  + #fix factors
                     log(IT):Family + #interactions
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  model5[fold$subsets[fold$which == i], ]$holdoutpred <- newpred
  model5[fold$subsets[fold$which == i], ]$RMSE=rmse
  model5[fold$subsets[fold$which == i], ]$MSE=mse
  model5[fold$subsets[fold$which == i], ]$MAE=mae
  model5[fold$subsets[fold$which == i], ]$R2=R2
  model5[fold$subsets[fold$which == i], ]$AIC=AIC(newlm)
  model5[fold$subsets[fold$which == i], ]$BIC=BIC(newlm)
  model5[fold$subsets[fold$which == i], ]$Fold=i
}

##Just IT
model6<-bee_mean%>%mutate(Fold=rep(0,nrow(bee_mean)),holdoutpred=rep(0,nrow(bee_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=model6[fold$subsets[fold$which != i], ]
  validation=model6[fold$subsets[fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT) + #interactions
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  model6[fold$subsets[fold$which == i], ]$holdoutpred <- newpred
  model6[fold$subsets[fold$which == i], ]$RMSE=rmse
  model6[fold$subsets[fold$which == i], ]$MSE=mse
  model6[fold$subsets[fold$which == i], ]$MAE=mae
  model6[fold$subsets[fold$which == i], ]$R2=R2
  model6[fold$subsets[fold$which == i], ]$AIC=AIC(newlm)
  model6[fold$subsets[fold$which == i], ]$BIC=BIC(newlm)
  model6[fold$subsets[fold$which == i], ]$Fold=i
}
```

```{r}
##PGLS
#Set up folds
set.seed(123)
fold_phy<-bee_phylo%>%fold_cv(.,k=5)

pgls1<-bee_phylo%>%mutate(Fold=rep(0,nrow(bee_phylo)),
                        holdoutpred=rep(0,nrow(bee_phylo)),
                        MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),
                        MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),
                        AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=pgls1[fold_phy$subsets[fold_phy$which != i], ]
  validation=pgls1[fold_phy$subsets[fold_phy$which == i], ]
  rownames(train)=train$Species
  rownames(validation)=validation$Species
  tree=ape::drop.tip(bee.phy, setdiff(bee.phy$tip.label,train$Genus))
  tree=phytools::genus.to.species.tree(tree, species=train$Species)
  train_vcv=ape::corPagel(value=0.52351,phy=tree,fixed=TRUE)
  
  newlm=nlme::gls(log(Spec.wgt)~log(IT)*Region,
                  correlation=train_vcv, method="ML",data=train)
  
  newpred=predict(newlm,newdata=validation)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  pgls1[fold_phy$subsets[fold_phy$which == i], ]$holdoutpred <- newpred
  pgls1[fold_phy$subsets[fold_phy$which == i], ]$RMSE=rmse
  pgls1[fold_phy$subsets[fold_phy$which == i], ]$MSE=mse
  pgls1[fold_phy$subsets[fold_phy$which == i], ]$MAE=mae
  pgls1[fold_phy$subsets[fold_phy$which == i], ]$R2=R2
  pgls1[fold_phy$subsets[fold_phy$which == i], ]$AIC=AIC(newlm)
  pgls1[fold_phy$subsets[fold_phy$which == i], ]$BIC=BIC(newlm)
  pgls1[fold_phy$subsets[fold_phy$which == i], ]$Fold=i
}

##JUST IT + Region
pgls2<-bee_phylo%>%mutate(Fold=rep(0,nrow(bee_phylo)),
                        holdoutpred=rep(0,nrow(bee_phylo)),
                        MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),
                        MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),
                        AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=pgls2[fold_phy$subsets[fold_phy$which != i], ]
  validation=pgls2[fold_phy$subsets[fold_phy$which == i], ]
  rownames(train)=train$Species
  rownames(validation)=validation$Species
  tree=ape::drop.tip(bee.phy, setdiff(bee.phy$tip.label,train$Genus))
  tree=phytools::genus.to.species.tree(tree, species=train$Species)
  train_vcv=ape::corPagel(value=0.5400448,phy=tree,fixed=TRUE)
  
  newlm=nlme::gls(log(Spec.wgt)~log(IT) + Region,
                  correlation=train_vcv, method="ML",data=train)
  
  newpred=predict(newlm,newdata=validation)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  pgls2[fold_phy$subsets[fold_phy$which == i], ]$holdoutpred <- newpred
  pgls2[fold_phy$subsets[fold_phy$which == i], ]$RMSE=rmse
  pgls2[fold_phy$subsets[fold_phy$which == i], ]$MSE=mse
  pgls2[fold_phy$subsets[fold_phy$which == i], ]$MAE=mae
  pgls2[fold_phy$subsets[fold_phy$which == i], ]$R2=R2
  pgls2[fold_phy$subsets[fold_phy$which == i], ]$AIC=AIC(newlm)
  pgls2[fold_phy$subsets[fold_phy$which == i], ]$BIC=BIC(newlm)
  pgls2[fold_phy$subsets[fold_phy$which == i], ]$Fold=i
}

##JUST IT
pgls3<-bee_phylo%>%mutate(Fold=rep(0,nrow(bee_phylo)),
                        holdoutpred=rep(0,nrow(bee_phylo)),
                        MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),
                        MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),
                        AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=pgls3[fold_phy$subsets[fold_phy$which != i], ]
  validation=pgls3[fold_phy$subsets[fold_phy$which == i], ]
  rownames(train)=train$Species
  rownames(validation)=validation$Species
  tree=ape::drop.tip(bee.phy, setdiff(bee.phy$tip.label,train$Genus))
  tree=phytools::genus.to.species.tree(tree, species=train$Species)
  train_vcv=ape::corPagel(value=0.6,phy=tree,fixed=TRUE)
  
  newlm=nlme::gls(log(Spec.wgt)~log(IT) + Region,
                  correlation=train_vcv, method="ML",data=train)
  
  newpred=predict(newlm,newdata=validation)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  pgls3[fold_phy$subsets[fold_phy$which == i], ]$holdoutpred <- newpred
  pgls3[fold_phy$subsets[fold_phy$which == i], ]$RMSE=rmse
  pgls3[fold_phy$subsets[fold_phy$which == i], ]$MSE=mse
  pgls3[fold_phy$subsets[fold_phy$which == i], ]$MAE=mae
  pgls3[fold_phy$subsets[fold_phy$which == i], ]$R2=R2
  pgls3[fold_phy$subsets[fold_phy$which == i], ]$AIC=AIC(newlm)
  pgls3[fold_phy$subsets[fold_phy$which == i], ]$BIC=BIC(newlm)
  pgls3[fold_phy$subsets[fold_phy$which == i], ]$Fold=i
}
```
Cane validation sets

```{r}

validation1=model1[fold$subsets[fold$which == 1], ]
validation2=model1[fold$subsets[fold$which == 2], ]
validation3=model1[fold$subsets[fold$which == 3], ]
validation4=model1[fold$subsets[fold$which == 4], ]
validation5=model1[fold$subsets[fold$which == 5], ]

VC1=Cane(IT=validation1$IT)
VC2=Cane(IT=validation2$IT)
VC3=Cane(IT=validation3$IT)
VC4=Cane(IT=validation4$IT)
VC5=Cane(IT=validation5$IT)

VCR1=rmse(log(VC1),log(validation1$Spec.wgt))
VCR2=rmse(log(VC2),log(validation2$Spec.wgt))
VCR3=rmse(log(VC3),log(validation3$Spec.wgt))
VCR4=rmse(log(VC4),log(validation4$Spec.wgt))
VCR5=rmse(log(VC5),log(validation5$Spec.wgt))
```

```{r}
K_sets=rbind(
model1%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T),
model2%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T),
model3%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T),
model4%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T),
model5%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T),
model6%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T),
pgls1%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T),
pgls2%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T),
pgls3%>%dplyr::select(.,15:20)%>%map_dbl(mean,na.rm=T))
rownames(K_sets)=c("lme1","lme2","lme3","lme4","lme5","lme6","pgls1","pgls2","pgls3")
K_sets=as.data.frame(K_sets)
K_sets
##Combine RMSEs
RMSE_sets=cbind(unique(model1$RMSE),
unique(model2$RMSE),
unique(model3$RMSE),
unique(model4$RMSE),
unique(model5$RMSE),
unique(model6$RMSE),
unique(pgls1$RMSE),
unique(pgls2$RMSE),
unique(pgls3$RMSE),
rbind(VCR1,VCR2,VCR3,VCR4,VCR5))
colnames(RMSE_sets)=c("LM1","LM2","LM3","LM4","LM5","LM6","PG1","PG2","PG3","JC89")
RMSE_sets=as.data.frame(RMSE_sets)

#Box plots
bee_RMSE=RMSE_sets%>%gather(.,1:10,key ="Model",value = "RMSE")%>%ggplot(aes(x=Model,y=RMSE,fill=Model))+geom_boxplot()+theme_bw()+ theme(aspect.ratio=1,axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+ggtitle("Bees")


```

Hoverflies
```{r}
#k-fold hoverflies

set.seed(123)
hov_fold<-hov_mean%>%fold_cv(.,k=5)

#IT + Sex
hov_model1<-hov_mean%>%plyr::mutate(Fold=rep(0,nrow(hov_mean)),holdoutpred=rep(0,nrow(hov_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=hov_model1[hov_fold$subsets[hov_fold$which != i], ]
  validation=hov_model1[hov_fold$subsets[hov_fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT) + Sex +#Fixed
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  hov_model1[hov_fold$subsets[hov_fold$which == i], ]$holdoutpred <- newpred
  hov_model1[hov_fold$subsets[hov_fold$which == i], ]$RMSE=rmse
  hov_model1[hov_fold$subsets[hov_fold$which == i], ]$MSE=mse
  hov_model1[hov_fold$subsets[hov_fold$which == i], ]$MAE=mae
  hov_model1[hov_fold$subsets[hov_fold$which == i], ]$R2=R2
  hov_model1[hov_fold$subsets[hov_fold$which == i], ]$AIC=AIC(newlm)
  hov_model1[hov_fold$subsets[hov_fold$which == i], ]$BIC=BIC(newlm)
  hov_model1[hov_fold$subsets[hov_fold$which == i], ]$Fold=i
}


##IT + Region+ Sex
hov_model2<-hov_mean%>%plyr::mutate(Fold=rep(0,nrow(hov_mean)),holdoutpred=rep(0,nrow(hov_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=hov_model2[hov_fold$subsets[hov_fold$which != i], ]
  validation=hov_model2[hov_fold$subsets[hov_fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT) + Sex+ Region+#Fixed
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  hov_model2[hov_fold$subsets[hov_fold$which == i], ]$holdoutpred <- newpred
  hov_model2[hov_fold$subsets[hov_fold$which == i], ]$RMSE=rmse
  hov_model2[hov_fold$subsets[hov_fold$which == i], ]$MSE=mse
  hov_model2[hov_fold$subsets[hov_fold$which == i], ]$MAE=mae
  hov_model2[hov_fold$subsets[hov_fold$which == i], ]$R2=R2
  hov_model2[hov_fold$subsets[hov_fold$which == i], ]$AIC=AIC(newlm)
  hov_model2[hov_fold$subsets[hov_fold$which == i], ]$BIC=BIC(newlm)
  hov_model2[hov_fold$subsets[hov_fold$which == i], ]$Fold=i
}

##IT + Sex + Region + Sub
hov_model3<-hov_mean%>%plyr::mutate(Fold=rep(0,nrow(hov_mean)),holdoutpred=rep(0,nrow(hov_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=hov_model3[hov_fold$subsets[hov_fold$which != i], ]
  validation=hov_model3[hov_fold$subsets[hov_fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)+Sex + Region+Subfamily+#Fixed
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  hov_model3[hov_fold$subsets[hov_fold$which == i], ]$holdoutpred <- newpred
  hov_model3[hov_fold$subsets[hov_fold$which == i], ]$RMSE=rmse
  hov_model3[hov_fold$subsets[hov_fold$which == i], ]$MSE=mse
  hov_model3[hov_fold$subsets[hov_fold$which == i], ]$MAE=mae
  hov_model3[hov_fold$subsets[hov_fold$which == i], ]$R2=R2
  hov_model3[hov_fold$subsets[hov_fold$which == i], ]$AIC=AIC(newlm)
  hov_model3[hov_fold$subsets[hov_fold$which == i], ]$BIC=BIC(newlm)
  hov_model3[hov_fold$subsets[hov_fold$which == i], ]$Fold=i
}

##IT + Sex + Sub
hov_model4<-hov_mean%>%plyr::mutate(Fold=rep(0,nrow(hov_mean)),holdoutpred=rep(0,nrow(hov_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=hov_model4[hov_fold$subsets[hov_fold$which != i], ]
  validation=hov_model4[hov_fold$subsets[hov_fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT) +Sex + Subfamily+#Fixed
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  hov_model4[hov_fold$subsets[hov_fold$which == i], ]$holdoutpred <- newpred
  hov_model4[hov_fold$subsets[hov_fold$which == i], ]$RMSE=rmse
  hov_model4[hov_fold$subsets[hov_fold$which == i], ]$MSE=mse
  hov_model4[hov_fold$subsets[hov_fold$which == i], ]$MAE=mae
  hov_model4[hov_fold$subsets[hov_fold$which == i], ]$R2=R2
  hov_model4[hov_fold$subsets[hov_fold$which == i], ]$AIC=AIC(newlm)
  hov_model4[hov_fold$subsets[hov_fold$which == i], ]$BIC=BIC(newlm)
  hov_model4[hov_fold$subsets[hov_fold$which == i], ]$Fold=i
}

##IT * Sex
hov_model5<-hov_mean%>%plyr::mutate(Fold=rep(0,nrow(hov_mean)),holdoutpred=rep(0,nrow(hov_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=hov_model5[hov_fold$subsets[hov_fold$which != i], ]
  validation=hov_model5[hov_fold$subsets[hov_fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT) * Sex +#Fixed
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  hov_model5[hov_fold$subsets[hov_fold$which == i], ]$holdoutpred <- newpred
  hov_model5[hov_fold$subsets[hov_fold$which == i], ]$RMSE=rmse
  hov_model5[hov_fold$subsets[hov_fold$which == i], ]$MSE=mse
  hov_model5[hov_fold$subsets[hov_fold$which == i], ]$MAE=mae
  hov_model5[hov_fold$subsets[hov_fold$which == i], ]$R2=R2
  hov_model5[hov_fold$subsets[hov_fold$which == i], ]$AIC=AIC(newlm)
  hov_model5[hov_fold$subsets[hov_fold$which == i], ]$BIC=BIC(newlm)
  hov_model5[hov_fold$subsets[hov_fold$which == i], ]$Fold=i
}

##IT * Sex+ Region
hov_model6<-hov_mean%>%plyr::mutate(Fold=rep(0,nrow(hov_mean)),holdoutpred=rep(0,nrow(hov_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=hov_model6[hov_fold$subsets[hov_fold$which != i], ]
  validation=hov_model6[hov_fold$subsets[hov_fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)*Sex + Region+#Fixed
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  hov_model6[hov_fold$subsets[hov_fold$which == i], ]$holdoutpred <- newpred
  hov_model6[hov_fold$subsets[hov_fold$which == i], ]$RMSE=rmse
  hov_model6[hov_fold$subsets[hov_fold$which == i], ]$MSE=mse
  hov_model6[hov_fold$subsets[hov_fold$which == i], ]$MAE=mae
  hov_model6[hov_fold$subsets[hov_fold$which == i], ]$R2=R2
  hov_model6[hov_fold$subsets[hov_fold$which == i], ]$AIC=AIC(newlm)
  hov_model6[hov_fold$subsets[hov_fold$which == i], ]$BIC=BIC(newlm)
  hov_model6[hov_fold$subsets[hov_fold$which == i], ]$Fold=i
}
##IT * Sex+ Region
hov_model7<-hov_mean%>%plyr::mutate(Fold=rep(0,nrow(hov_mean)),holdoutpred=rep(0,nrow(hov_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=hov_model7[hov_fold$subsets[hov_fold$which != i], ]
  validation=hov_model7[hov_fold$subsets[hov_fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)  + Subfamily+#Fixed
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  hov_model7[hov_fold$subsets[hov_fold$which == i], ]$holdoutpred <- newpred
  hov_model7[hov_fold$subsets[hov_fold$which == i], ]$RMSE=rmse
  hov_model7[hov_fold$subsets[hov_fold$which == i], ]$MSE=mse
  hov_model7[hov_fold$subsets[hov_fold$which == i], ]$MAE=mae
  hov_model7[hov_fold$subsets[hov_fold$which == i], ]$R2=R2
  hov_model7[hov_fold$subsets[hov_fold$which == i], ]$AIC=AIC(newlm)
  hov_model7[hov_fold$subsets[hov_fold$which == i], ]$BIC=BIC(newlm)
  hov_model7[hov_fold$subsets[hov_fold$which == i], ]$Fold=i
}
##IT
hov_model8<-hov_mean%>%plyr::mutate(Fold=rep(0,nrow(hov_mean)),holdoutpred=rep(0,nrow(hov_mean)),MSE=rep(0,nrow(.)),RMSE=rep(0,nrow(.)),MAE=rep(0,nrow(.)),R2=rep(0,nrow(.)),AIC=rep(0,nrow(.)),BIC=rep(0,nrow(.)))
for(i in 1:5){
  train=hov_model8[hov_fold$subsets[hov_fold$which != i], ]
  validation=hov_model8[hov_fold$subsets[hov_fold$which == i], ]
  newlm=lme4::lmer(formula=log(Spec.wgt) ~ log(IT)+#Fixed
                     (1|Measurement)+(1|Species),data=train)
  newpred=predict(newlm,newdata=validation,allow.new.levels=TRUE)
  true=log(validation$Spec.wgt)
  error=(true-newpred)
  rmse=sqrt(mean(error^2))
  mse=mean((newpred-true)^2)
  R2=1-(sum((true-newpred)^2)/sum((true-mean(true))^2))
  mae=mean(abs(error))
  hov_model8[hov_fold$subsets[hov_fold$which == i], ]$holdoutpred <- newpred
  hov_model8[hov_fold$subsets[hov_fold$which == i], ]$RMSE=rmse
  hov_model8[hov_fold$subsets[hov_fold$which == i], ]$MSE=mse
  hov_model8[hov_fold$subsets[hov_fold$which == i], ]$MAE=mae
  hov_model8[hov_fold$subsets[hov_fold$which == i], ]$R2=R2
  hov_model8[hov_fold$subsets[hov_fold$which == i], ]$AIC=AIC(newlm)
  hov_model8[hov_fold$subsets[hov_fold$which == i], ]$BIC=BIC(newlm)
  hov_model8[hov_fold$subsets[hov_fold$which == i], ]$Fold=i
}

Hov_K_sets=rbind(
  hov_model1%>%dplyr::select(.,16:21)%>%map_dbl(median,na.rm=T),
  hov_model2%>%dplyr::select(.,16:21)%>%map_dbl(median,na.rm=T),
  hov_model3%>%dplyr::select(.,16:21)%>%map_dbl(median,na.rm=T),
  hov_model4%>%dplyr::select(.,16:21)%>%map_dbl(median,na.rm=T),
  hov_model5%>%dplyr::select(.,16:21)%>%map_dbl(median,na.rm=T),
  hov_model6%>%dplyr::select(.,16:21)%>%map_dbl(median,na.rm=T),
  hov_model7%>%dplyr::select(.,16:21)%>%map_dbl(median,na.rm=T),
  hov_model8%>%dplyr::select(.,16:21)%>%map_dbl(median,na.rm=T))
rownames(Hov_K_sets)=c("LM1","LM2","LM3","LM4","LM5","LM6","LM7","LM8")
Hov_K_sets

##Combine RMSEs
Hov_RMSE_sets=cbind(unique(hov_model1$RMSE),
                unique(hov_model2$RMSE),
                unique(hov_model3$RMSE),
                unique(hov_model4$RMSE),
                unique(hov_model5$RMSE),
                unique(hov_model6$RMSE),
                unique(hov_model7$RMSE),
                unique(hov_model8$RMSE))
colnames(Hov_RMSE_sets)=c("LM1","LM2","LM3","LM4","LM5","LM6","LM7","LM8")
Hov_RMSE_sets=as.data.frame(Hov_RMSE_sets)

#Box plots
Hov_RMSE=Hov_RMSE_sets%>%gather(.,1:8,key ="Model",value = "RMSE")%>%ggplot(aes(x=Model,y=RMSE,fill=Model))+geom_boxplot()+theme_bw()+ theme(aspect.ratio=1,axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+ggtitle("Hoverflies")

```

#RMSE plots
```{r}
bee_RMSE2=ggplotGrob(bee_RMSE)
Hov_RMSE2=ggplotGrob(Hov_RMSE)
grid.draw(cbind(bee_RMSE2, Hov_RMSE2, size = "first"))

```

##Intraspecific predictions and variation

##Body size predictions - just females
```{r}

bee_top5=rbind(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",],
               bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",],
               bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",],
               bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",],
               bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",])

HU_lm=lm(log(Spec.wgt)~log(IT),data=bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",])

LP_lm=lm(log(Spec.wgt)~log(IT),data=bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",])

BL_lm=lm(log(Spec.wgt)~log(IT),bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",])

AF_lm=lm(log(Spec.wgt)~log(IT),bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",])

LL_lm=lm(log(Spec.wgt)~log(IT),bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",])

summary(HU_lm)
summary(LP_lm)
summary(BL_lm)
summary(AF_lm)
summary(LL_lm)

#HOVERFLIES
hov_top5=rbind(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",],
               hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",],
               hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",],
               hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",],
               hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",])

HP_lm=lm(log(Spec.wgt)~log(IT),data=hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",])

SM_lm=lm(log(Spec.wgt)~log(IT),data=hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",])

EB_lm=lm(log(Spec.wgt)~log(IT),hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",])

MS_lm=lm(log(Spec.wgt)~log(IT),hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",])

AA_lm=lm(log(Spec.wgt)~log(IT),hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",])

summary(HP_lm)
summary(SM_lm)
summary(EB_lm)
summary(MS_lm)
summary(AA_lm)

int_bee1=ggplot(data=bee_top5,aes(x=log(Spec.wgt),y=log(IT),col=Species))+
  geom_point(pch=1)+
  geom_smooth(method="lm",se=FALSE)+
  theme_bw()+ theme(aspect.ratio=1)+ggtitle("Bees")
int_hov1=ggplot(data=hov_top5,aes(x=log(Spec.wgt),y=log(IT),col=Species))+
  geom_point(pch=1)+
  geom_smooth(method="lm",se=FALSE)+
  theme_bw()+ theme(aspect.ratio=1)+ggtitle("Hoverflies")

grid.arrange(int_bee1,int_hov1,ncol=2,nrow=1)

int_bee2=ggplotGrob(int_bee1)
int_hov2=ggplotGrob(int_hov1)
grid.draw(cbind(int_bee2, int_hov2, size = "first"))

```

##Bee intraspecific variation with sample size
```{r,echo=FALSE}
#Homalictus_urbanus
#Lasioglossum_pauxillum
#Bombus_lucorum
#Andrena_flavipes
#Lasioglossum_lanarium

bee_species=split(bee_all,bee_all$Species)

set.seed(123)
##ONE##
#Homalictus_urbanus
#IT
HU_IT = c()
for(i in 1:length(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",]$IT)){
  subset1 = sample(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",]$IT, i)
  HU_IT[i] = mean(subset1)
}


#Specimen weight
HU_WT = c()
for(i in 1:length(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",]$Spec.wgt, i)
  HU_WT[i] = mean(subset1)
}


##TWO##

#Lasioglossum_pauxillum
#IT
LP_IT = c()
for(i in 1:length(bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",]$IT)){
  subset1 = sample(bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",]$IT, i)
  LP_IT[i] = mean(subset1)
}


#Specimen weight
LP_WT = c()
for(i in 1:length(bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",]$Spec.wgt, i)
  LP_WT[i] = mean(subset1)
}


##THREE
#Bombus_lucorum
BL_IT = c()
for(i in 1:length(bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",]$IT)){
  subset1 = sample(bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",]$IT, i)
  BL_IT[i] = mean(subset1)
}


#Specimen weight
BL_WT = c()
for(i in 1:length(bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",]$Spec.wgt, i)
  BL_WT[i] = mean(subset1)
}

##FOUR##
#Andrena_flavipes
#IT
AF_IT = c()
for(i in 1:length(bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",]$IT)){
  subset1 = sample(bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",]$IT, i)
  AF_IT[i] = mean(subset1)
}


#Specimen weight
AF_WT = c()
for(i in 1:length(bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",]$Spec.wgt, i)
  AF_WT[i] = mean(subset1)
}

##FIVE##
#Lasioglossum_lanarium
LL_IT = c()
for(i in 1:length(bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",]$IT)){
  subset1 = sample(bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",]$IT, i)
  LL_IT[i] = mean(subset1)
}

#Specimen weight
LL_WT = c()
for(i in 1:length(bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",]$Spec.wgt, i)
  LL_WT[i] = mean(subset1)
}

par(pty="s")
par(mfrow=c(2,5))
#1
plot(HU_IT,main="Homalictus urbanus",ylab = "ITD (mm)",xlab="")
abline(a=HU_IT[211],b=0,col=2)
abline(a=confint(lm(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",]$IT~1))[2],b=0,col=3)
#2
plot(LP_IT,main="Lasioglossum pauxillum",ylab = "ITD (mm)",xlab="")
abline(a=LP_IT[112],b=0,col=2)
abline(a=confint(lm(bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",]$IT~1))[2],b=0,col=3)
#3
plot(BL_IT,main="Bombus lucorum",ylab = "ITD (mm)",xlab="")
abline(a=BL_IT[103],b=0,col=2)
abline(a=confint(lm(bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",]$IT~1))[2],b=0,col=3)
#4
plot(AF_IT,main="Andrena flavipes",ylab = "ITD (mm)",xlab="")
abline(a=AF_IT[59],b=0,col=2)
abline(a=confint(lm(bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",]$IT~1))[2],b=0,col=3)
#5
plot(LL_IT,main="Lasioglossum lanarium",ylab = "ITD (mm)",xlab="")
abline(a=LL_IT[63],b=0,col=2)
abline(a=confint(lm(bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",]$IT~1))[2],b=0,col=3)

#1
plot(HU_WT)
abline(a=HU_WT[211],b=0,col=2)
abline(a=confint(lm(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Homalictus_urbanus[bee_species$Homalictus_urbanus$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)
#2
plot(LP_WT)
abline(a=LP_WT[112],b=0,col=2)
abline(a=confint(lm(bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Lasioglossum_pauxillum[bee_species$Lasioglossum_pauxillum$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)
#3
plot(BL_WT)
abline(a=BL_WT[103],b=0,col=2)
abline(a=confint(lm(bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Bombus_lucorum[bee_species$Bombus_lucorum$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)
#4
plot(AF_WT)
abline(a=AF_WT[59],b=0,col=2)
abline(a=confint(lm(bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Andrena_flavipes[bee_species$Andrena_flavipes$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)
#5
plot(LL_WT)
abline(a=LL_WT[63],b=0,col=2)
abline(a=confint(lm(bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(bee_species$Lasioglossum_lanarium[bee_species$Lasioglossum_lanarium$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)

```

##Hoverfly intraspecific variation with sample size

```{r,echo=FALSE}

set.seed(123)
##ONE##
#Austrosyrphus 
HAA_IT = c()
for(i in 1:length(hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",]$IT)){
  subset1 = sample(hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",]$IT, i)
  HAA_IT[i] = mean(subset1)
}


#Specimen weight
HAA_WT = c()
for(i in 1:length(hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",]$Spec.wgt, i)
  HAA_WT[i] = mean(subset1)
}
##TWO##
#Helophilus_parallelus
#IT
HHP_IT = c()
for(i in 1:length(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",]$IT)){
  subset1 = sample(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",]$IT, i)
  HHP_IT[i] = mean(subset1)
}

#Specimen weight
HHP_WT = c()
for(i in 1:length(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",]$Spec.wgt, i)
  HHP_WT[i] = mean(subset1)
}


##THREE

#Sphaerophoria_macrogaster
#IT
HSM_IT = c()
for(i in 1:length(hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",]$IT)){
  subset1 = sample(hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",]$IT, i)
  HSM_IT[i] = mean(subset1)
}

#Specimen weight
HSM_WT = c()
for(i in 1:length(hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",]$Spec.wgt, i)
  HSM_WT[i] = mean(subset1)
}

##FOUR##
#Episyrphus_balteatus
HEB_IT = c()
for(i in 1:length(hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",]$IT)){
  subset1 = sample(hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",]$IT, i)
  HEB_IT[i] = mean(subset1)
}

#Specimen weight
HEB_WT = c()
for(i in 1:length(hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",]$Spec.wgt, i)
  HEB_WT[i] = mean(subset1)
}

##FIVE##
#Melanostoma_scalare
#IT
HMS_IT = c()
for(i in 1:length(hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",]$IT)){
  subset1 = sample(hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",]$IT, i)
  HMS_IT[i] = mean(subset1)
}

#Specimen weight
HMS_WT = c()
for(i in 1:length(hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",]$Spec.wgt)){
  subset1 = sample(hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",]$Spec.wgt, i)
  HMS_WT[i] = mean(subset1)
}




##graphed three for aesthetics based on size range
par(mfrow=c(2,5))
par(pty="s")
plot(HAA_IT,main="Austrosyrphus spp.",ylab = "ITD (mm)",xlab="")
abline(a=HAA_IT[32],b=0,col=2)
abline(a=confint(lm(hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",]$IT~1))[2],b=0,col=3)

plot(HHP_IT,main="Helophilus parallelus",ylab = "",xlab="",ylim=c(3.6,4))
abline(a=HHP_IT[19],b=0,col=2)
abline(a=confint(lm(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",]$IT~1))[2],b=0,col=3)

plot(HEB_IT,main="Episyrphus balteatus",ylab = "",xlab="",ylim=c(2.1,2.55))
abline(a=HEB_IT[11],b=0,col=2)
abline(a=confint(lm(hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",]$IT~1))[2],b=0,col=3)

plot(HSM_IT,main="Sphaerophoria macrogaster",ylab = "",xlab="",ylim=c(1.1,1.5))
abline(a=HSM_IT[10],b=0,col=2)
abline(a=confint(lm(hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",]$IT~1))[2],b=0,col=3)

plot(HMS_IT,main="Melanostoma scalare",ylab = "",xlab="",ylim=c(1.45,1.7))
abline(a=HMS_IT[9],b=0,col=2)
abline(a=confint(lm(hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",]$IT~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",]$IT~1))[2],b=0,col=3)

plot(HAA_WT,ylab = "Specimen weight (mg)",xlab="Sample size")
abline(a=HAA_WT[32],b=0,col=2)
abline(a=confint(lm(hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Austrosyphus_aussp1[hov_species$Austrosyphus_aussp1$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)

plot(HHP_WT,ylab = "",xlab="Sample size",ylim=c(32,42))
abline(a=HHP_WT[19],b=0,col=2)
abline(a=confint(lm(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Helophilus_parallelus[hov_species$Helophilus_parallelus$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)

plot(HEB_WT,ylab = "",xlab="Sample size",ylim=c(6,14))
abline(a=HEB_WT[11],b=0,col=2)
abline(a=confint(lm(hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Episyrphus_balteatus[hov_species$Episyrphus_balteatus$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)

plot(HSM_WT,ylab = "",xlab="Sample size",ylim=c(1.2,2))
abline(a=HSM_WT[10],b=0,col=2)
abline(a=confint(lm(hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Sphaerophoria_macrogaster[hov_species$Sphaerophoria_macrogaster$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)

plot(HMS_WT,ylab = "",xlab="Sample size",ylim=c(1.5,6.5))
abline(a=HMS_WT[9],b=0,col=2)
abline(a=confint(lm(hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",]$Spec.wgt~1))[1],b=0,col=3)
abline(a=confint(lm(hov_species$Melanostoma_scalare[hov_species$Melanostoma_scalare$Sex == "Female",]$Spec.wgt~1))[2],b=0,col=3)

```

##Test of preservative time - Australia and German bees

LME
```{r}

pres.lme=lmer(log(Spec.wgt)~IT+Pres.time+Sex+(1|Species)+(1|Country),bee_pres)

summary(pres.lme)
plot(pres.lme)

```
